---
title: "Forecasting Electricity Consumption & Losses For Residential, Commercial, and Industrial Sectors"
subtitle: "04/26/2023"
author: "Lynn Wu, Haru Koga, Miaojun Pang"
output: pdf_document
geometry: margin=2.54cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction and Objectives

Energy consumption is a critical indicator for policymakers, industry stakeholders, and researchers to develop effective energy policies and solutions for an effective use of electricity and power loss reduction. However, accurately forecasting and analyzing energy consumption data can be challenging to obtain, as most data are preliminary and subject to revision.

In this project, we will use time series analysis in R to forecast and analyze energy consumption data for three sectors: residential, commercial, and industrial, in the United States, from February 1973 to November 2022. Motivated by the importance of accurate and reliable energy consumption data, this project aims to contribute to a better understanding of energy trends and help inform policy and decision-making in the energy sector. By forecasting and analyzing the U.S. Energy Information Administrationâ€™s data on residential, commercial, and industrial uses, we hope to shed light on the drivers of energy consumption in these sectors and identify potential opportunities for reducing energy consumption and improving energy efficiency. 

Moreover, in the time range of February 1973 to November 2022, the United States has experienced a number of political and natural disturbances, such as recessions, pandemics, and natural disasters. Those external factors frequently have an impact on electricity consumption. Then this project aims to explore the impacts of external disturbances on energy consumption in each sector. Forecasting the energy consumption could help ensure the reliability of the energy needs in each sector amid the turmoil and further seek the potential use of emerging technologies such as energy storage in the respective sector. 

Objectives
The objective of this study is to analyze: 

  (1) Effective use of electricity in the residential, commercial, and industrial sectors while considering the energy loss data
  
  (2) How energy consumption gets affected by natural and political disturbances in each sector 
  
  (3) Potential in the use of energy technologies, such as electricity storage, by the sectors

```{r package, message=FALSE, warning=FALSE, include=FALSE}
## install packages
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(kableExtra)
library(knitr)
library(forecast)

```

## Dataset Information
The Energy Information Administration (EIA) is the best source of energy data in the United States. It puts out detailed monthly and annual reports on energy production, consumption, stocks, trade, and the effects of different energy sources on the environment. The dataset on energy consumption by the three sectors of residential, commercial, and industrial, covering the period from February 1973 to November 2022, has been selected for analysis for the purposes of this study. This data set has five metrics for each sector, including total energy consumption, end-use energy consumption, energy losses in the electrical system, and primary energy consumption. In order to better understand the patterns of electricity use and energy efficiency in the three sectors, our study focuses on two variables: primary energy consumption and energy losses. Most energy sources, including coal, natural gas, petroleum, geothermal, solar, and biomass, are included in primary energy consumption.
Overall, the following steps were applied to our dataset:

  (1) Download the dataset from EIA.
  
  (2) Import the dataset to R and delete the unit column.
  
  (3) Keep two variables for three sectors.
  
  (4) Convert the dataset from characters to numerical.
  
  (5) Round all numbers to three decimal places.
  
  (6) Create a date's data frame.
  
  (7) Convert the original dataset into time series data for forecasting and summarize it.
  
  (8) Calculate the mean, standard deviation, maximum values, minimum values, and ranges for primary energy consumption and electrical losses in three sectors.
  
  (9) Make a summary statistics table.
  
  (10) Utilize ggplot() to compare three sectors using two initial plots that are variable-classified.


```{r message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
#Import the excel file
library(readxl)
electricity_consumption <- read_excel(path="./Table_2.1a__Energy_Consumption__Residential_-_Commercial_-_and_Industrial_Sectors.xlsx",skip = 10, sheet="Monthly Data",col_names=TRUE) 

#delete the first row with units
electricity_consumption<-electricity_consumption[-1,]

#Keep two columns: primary energy consumption and energy losses for three sectors, respectively
electricity_consumption<-electricity_consumption[,-3][,-3][,-4]
electricity_consumption<-electricity_consumption[,-5][,-5][,-6]
electricity_consumption<-electricity_consumption[,-7][,-7][,-8]

#Round to three digits for all columns
class(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
electricity_consumption$`Primary Energy Consumed by the Residential Sector` <- as.numeric(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
round(electricity_consumption$`Primary Energy Consumed by the Residential Sector`,digits=3)

class(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
electricity_consumption$`Residential Sector Electrical System Energy Losses` <- as.numeric(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
round(electricity_consumption$`Residential Sector Electrical System Energy Losses`,digits=3)

class(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
electricity_consumption$`Primary Energy Consumed by the Commercial Sector` <- as.numeric(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
round(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`,digits=3)

class(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
electricity_consumption$`Commercial Sector Electrical System Energy Losses` <- as.numeric(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
round(electricity_consumption$`Commercial Sector Electrical System Energy Losses`,digits=3)

class(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
electricity_consumption$`Primary Energy Consumed by the Industrial Sector` <- as.numeric(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
round(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`,digits=3)

class(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
electricity_consumption$`Industrial Sector Electrical System Energy Losses` <- as.numeric(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
round(electricity_consumption$`Industrial Sector Electrical System Energy Losses`,digits=3)

colnames(electricity_consumption)<-c('Date','Residential.Primary.Energy','Residential.Energy.Losses','Commercial.Primary.Energy','Commercial.Energy.Losses','Industrial.Primary.Energy','Industrial.Energy.Losses')

head(electricity_consumption)
tail(electricity_consumption)
```



```{r message=FALSE, warning=FALSE, Include=FALSE, echo=FALSE}
#Transform to time series data
Date_frame<-as.Date(electricity_consumption$Month)
ts_electricity <- ts(electricity_consumption[,2:7],start=c(1973,01),end=c(2022,11),frequency=12)

#Summary of time series data
summary_data<-summary(ts_electricity)
summary_data

#Calculate means, standard deviations, and ranges for each variable

mean_R1<-mean(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
sd_R1<-sd(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
max_R1<-max(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
min_R1<-min(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
range_R1<-max(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)-min(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)

mean_R2<-mean(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
sd_R2<-sd(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
max_R2<-max(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
min_R2<-min(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
range_R2<-max(electricity_consumption$`Residential Sector Electrical System Energy Losses`)-min(electricity_consumption$`Residential Sector Electrical System Energy Losses`)

mean_C1<-mean(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
sd_C1<-sd(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
max_C1<- max(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
min_C1<- min(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
range_C1<-max(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)-min(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)

mean_C2<-mean(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
sd_C2<-sd(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
max_C2<- max(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
min_C2<- min(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
range_C2<-max(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)-min(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)

mean_I1<-mean(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
sd_I1<-sd(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
max_I1<-max(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
min_I1<-min(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
range_I1<-max(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)-min(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)

mean_I2<-mean(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
sd_I2<-sd(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
max_I2<-max(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
min_I2<-min(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
range_I2<-max(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)-min(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)

# Create a table
summary_df <- data.frame(
  Variable = c("Residential_Sector_Consumption", "Residential_Sector_Losses", "Commercial_Sector_Consumption", "Commercial_Sector_Losses", "Industrial_Sector_Consumption", "Industrial_Sector_Losses"),
  Mean = c(584.60,662.45,345.14,605.47,1806.54,576.51),
  StandardDeviation = c(321.54,185.03,146.90,178.14,146.71,68.86),
  Max = c(1488.0, 1144.8,703.6,982.2,2267,776.8),
  Min = c(192.3,325.3,165.3,258.2,1466,405.0),
  Range = c(1295.71,819.46,538.31,723.97,800.93,371.76)
)
  

```

The following table and figures are visualized here:

```{r message=FALSE, warning=FALSE, echo=FALSE}
summary_table<-kbl(summary_df, caption="Table 1. Summary Statistics Table used with ts() function") %>% 
  kable_styling(full_width = FALSE, position = "center",latex_options = "hold_position")
summary_table
```

The industrial sector has the highest average consumption (1806.54 trillion BTU) when comparing primary electrical consumption across the three sectors (Table 1). Despite the similar average energy losses across all three sectors, the residential sector nevertheless suffers from the highest energy losses as a result of overcoming transmission line resistance.
The residential sector has the highest primary electricity consumption, whereas the industrial sector has the lowest energy losses, according to a comparison of standard deviations that we also conducted.
The ranges show the fundamental seasonal shifts over the last few decades. For primary electricity consumption, the residential sector has the strongest seasonality, while the industrial sector exhibits the least seasonality.


```{r, echo=FALSE}
## Initial Plots
#plot for electricity consumption
cols<-c("residential"="orange","commercial"="steelblue","industrial"="yellow")
ts_plot<-ggplot(electricity_consumption, size=4)+
  geom_line(aes(x=Date,y=Residential.Primary.Energy,color="residential"))+
  ylab(paste0("Electricity Consumption (Trillion BTU)",sep="")) +
  xlab("Date")+
  geom_line(aes(x=Date,y=Commercial.Primary.Energy,color="commercial"))+
  geom_line(aes(x=Date,y=Industrial.Primary.Energy,color="industrial"))+
  labs(title="Figure 1. Primary Electricity Consumption of Three Sectors")+
  theme(plot.margin = margin(2,.8,2,.8, "cm"))+
  scale_color_manual(name="series",values = cols)
plot(ts_plot)

```

The highest primary energy consumption in Figure 1 is in the industrial sector. Although there is the most seasonality in the residential sector, the commercial sector uses the least primary energy. Strong seasonality is typically more pronounced in the residential and industrial sectors in the summer and winter but less pronounced in the spring and fall. In general, residential and commercial sector patterns are nearly stable; however, exogenous influences throughout time cause the industrial sector to experience increasing and declining trends.

```{r, echo=FALSE}
## Initial Plots
#plot for energy losses
cols1<-c("residential"="green","commercial"="red","industrial"="blue")
ts_plot1<-ggplot(electricity_consumption, size=4)+
  geom_line(aes(x=Date,y=Residential.Energy.Losses,color="residential"))+
  ylab(paste0("Energy Losses (Trillion BTU)",sep="")) +
  xlab("Date")+
  geom_line(aes(x=Date,y=Commercial.Energy.Losses,color="commercial"))+
  geom_line(aes(x=Date,y=Industrial.Energy.Losses,color="industrial"))+
  labs(title="Figure 2. Energy Losses of Three Sectors")+
  theme(plot.margin = margin(2,.8,2,.8, "cm"))+
  scale_color_manual(name="series",values = cols1)
plot(ts_plot1)

```

In contrast to the commercial and residential sectors in Figure 2, the electrical losses in the industrial sectors are decreasing. In three sectors, electricity losses are highest in the residential sector while being lowest in the industrial sector. Three industries saw an increasing tendency in energy losses prior to 2000, but after that year, they saw decreasing trends.

We initially build three sub-data frames containing the two variables primary electricity consumption and energy losses for each of the three sectors. All data were converted to time series data. To compute five one seasonality models, forecast consumption and losses from 2017 to 2022, and determine the most effective forecasting models for the next 10 years, all three sectors also contain one testing dataset and one training dataset between 1973 and 2017.

```{r message=FALSE, warning=FALSE, Include=FALSE, echo=FALSE}
###Residential Sector
#Create a dataframe only for Residential
electricity_consumption_R<-electricity_consumption[,-4:-7]
colnames(electricity_consumption_R)<-c('Date','Primary.Energy','Energy.Losses')

#Inspect data
#head(electricity_price)
nvar <- ncol(electricity_consumption_R) - 1
nobs <- nrow(electricity_consumption_R)

#transform to time series data
ts_electricity_R <- ts(
  electricity_consumption_R[,2:(nvar+1)],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_R_PE_test <- ts(
  electricity_consumption_R[,2],
  start=c(2017,12,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_R_EL_test <- ts(
  electricity_consumption_R[,3],
  start=c(2017,12,01),end=c(2022,11,01),
  frequency=12)

```

```{r message=FALSE, warning=FALSE, Include=FALSE, echo=FALSE}
# Create a variable with number of steps ahead we will forecast
#Three years as test variable
n_for <- 60

ts_forPE_R_train <- ts(ts_electricity_R[1:(nobs-n_for),"Primary.Energy"],
                start=c(1973,02,01),
               frequency=12)

last_forPE_obs_R_test <- ts_electricity_R[(nobs-n_for+1):nobs,"Primary.Energy"]


ts_forEL_R_train <- ts(ts_electricity_R[1:(nobs-n_for),"Energy.Losses"],
               start=c(1973,02,01),
               frequency=12)
last_EL_obs_R_test <- ts_electricity_R[(nobs-n_for+1):nobs,"Energy.Losses"]


```

```{r include=FALSE}
###Commercial
#Create a dataframe only for Residential
electricity_consumption_C<-electricity_consumption[c(1,4,5)]
colnames(electricity_consumption_C)<-c('Date','Primary.Energy','Energy.Losses')

#Inspect data
#head(electricity_price)
nvar <- ncol(electricity_consumption_C) - 1
nobs <- nrow(electricity_consumption_C)

#transform to time series data
ts_electricity_C <- ts(
  electricity_consumption_C[,2:(nvar+1)],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_C_PE_test <- ts(
  electricity_consumption_C[,2],
  start=c(2017,12,01),end=c(2022,11,01),
  frequency=12)


ts_electricity_C_EL_test <- ts(
  electricity_consumption_C[,3],
  start=c(2017,12,01),end=c(2022,11,01),
  frequency=12)

```

```{r include=FALSE}
###Industrial
#Create a dataframe only for Industrial
electricity_consumption_I<-electricity_consumption[c(1,6,7)]
colnames(electricity_consumption_I)<-c('Date','Primary.Energy','Energy.Losses')

#Inspect data
#head(electricity_price)
nvar <- ncol(electricity_consumption_I) - 1
nobs <- nrow(electricity_consumption_I)
#transform to time series
ts_electricity_I <- ts(
  electricity_consumption_I[,2:(nvar+1)],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_I_PE_test <- ts(
  electricity_consumption_I[,2],
  start=c(2017,12,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_I_EL_test <- ts(
  electricity_consumption_I[,3],
  start=c(2017,12,01),end=c(2022,11,01),
  frequency=12)

```

Before running a time series forecast model and selecting models for time series forecasting, we examine ACF and PACF plots of the original, un-transformed time series (shown below). For the following plots, we use R, C, and I to stand for residential, commericial, and industrial sectors, respectively.

```{r echo=FALSE}
#ACF and PACF plots for primary energy consumption
par(mfrow=c(1,6))
  ACF_Plot1 <- Acf(electricity_consumption_R$Primary.Energy, lag = 30, plot = TRUE,main="R ACF",ylim=c(-0.2,0.8))
  PACF_Plot1 <- Pacf(electricity_consumption_R$Primary.Energy, lag = 30, plot = TRUE,main="R PACF",ylim=c(-0.2,0.8))
  ACF_Plot2 <- Acf(electricity_consumption_C$Primary.Energy, lag = 30, plot = TRUE,main="C ACF",ylim=c(-0.2,0.8))
  PACF_Plot2 <- Pacf(electricity_consumption_C$Primary.Energy, lag = 30, plot = TRUE,main="C PACF",ylim=c(-0.2,0.8))
  ACF_Plot3 <- Acf(electricity_consumption_I$Primary.Energy, lag = 30, plot = TRUE,main="I ACF",ylim=c(-0.2,0.8))
  PACF_Plot3 <- Pacf(electricity_consumption_I$Primary.Energy, lag = 30, plot = TRUE,main="I PACF",ylim=c(-0.2,0.8))

```

For our first variable--primary energy consumption, both ACF and PACF not only show strong seasonality but also non-stationary due to slow decays.

```{r echo=FALSE}
#ACF and PACF plots for energy losses

par(mfrow=c(1,6))
  ACF_Plot4 <- Acf(electricity_consumption_R$Energy.Losses, lag = 30, plot = TRUE,main="R ACF",ylim=c(-0.2,0.8))
  PACF_Plot4 <- Pacf(electricity_consumption_R$Energy.Losses, lag = 30, plot = TRUE,main="R PACF",ylim=c(-0.2,0.8))
  ACF_Plot5 <- Acf(electricity_consumption_C$Energy.Losses, lag = 30, plot = TRUE,main="C ACF",ylim=c(-0.2,0.8))
  PACF_Plot5 <- Pacf(electricity_consumption_C$Energy.Losses, lag = 30, plot = TRUE,main="C PACF",ylim=c(-0.2,0.8))
  ACF_Plot6 <- Acf(electricity_consumption_I$Energy.Losses, lag = 30, plot = TRUE,main="I ACF",ylim=c(-0.2,0.8))
  PACF_Plot6 <- Pacf(electricity_consumption_I$Energy.Losses, lag = 30, plot = TRUE,main="I PACF",ylim=c(-0.2,0.8))
```

For our second variable--energy loss, both ACF and PACF still show significant values beyond thresholds, especially at lags=12 and 24.

## Analysis (Methods and Models)

For our forecast training for all the three sectors, we run five models: Arithmetic Mean (MEAN), Seasonal Naive (SNAIVE), Seasonal ARIMA (SARIMA), State Space Exponential Smoothing (SSES), and Basic Structure Model (BSM). We created a training dataset for each sector which has observations from February 1973 to November 2017, and the forecast testing window is 5 years from November 2017 to November 2022. We fit the single-seasonality time series data from each sector to the above five models for the primary energy consumption and energy losses 5-year forecasting. Having the five models run, we identify the best model from the result values of RMSE from an accuracy test. Finally, the identified best models are used to forecast the next ten years (2022-2032) of primary energy consumption and energy losses in the three sectors. The results and discussion will be given below by sectors. 

  (1) The arithmetic mean model is a simple forecasting method that assumes that the future values of a time series will be equal to the average of past values. The code implements this model to forecast primary energy consumption and energy losses.

  (2) The seasonal naive model was implemented to forecast primary energy consumption and energy losses, and the plot shows that there is a significant seasonal trend in the data. The seasonal naive model takes into account the seasonality in the data and forecasts future values based on the same seasonal pattern observed in the historical data.
  
  (3) The plots of the SARIMA forecasts for both primary energy consumption and energy losses show a continuation of the recurring pattern observed in the historical data, indicating that the SARIMA model is capturing the seasonality in the data. However, it is important to assess the accuracy of the forecasts by checking the residuals and other model diagnostics before making any conclusions about the effectiveness of the model.
  
  (4) We were fitting state space models using exponential smoothing to the original (seasonal) time series data for primary energy consumption and energy losses. The SSES model uses exponential smoothing to capture the seasonality and trend in the data.
  
  (5) Model 5 fits state space models using StructTS() to the original (seasonal) time series data for primary energy consumption and energy losses. The StructTS() function can estimate various state space models with different types of time-varying components, including trend, seasonality, and cycle. The forecasts generated by the models are plotted for both primary energy consumption and energy losses.

## Residential sector

We begin with the residential sector.

```{r include=FALSE}
## Model 1: Arithmetic mean
#mean model for primary energy consumption
MEAN_seas1 <- meanf(y = ts_forPE_R_train, h = n_for)  
checkresiduals(MEAN_seas1)


#mean model for energy losses
MEAN_seas2 <- meanf(y = ts_forEL_R_train, h = n_for)  
checkresiduals(MEAN_seas2)

```

```{r include=FALSE}
plot(MEAN_seas1)
```

```{r include=FALSE}
plot(MEAN_seas2)
```


```{r include=FALSE}
## Model 2: Seasonal naive
#seasonal naive model for primary energy consumption
SNAIVE_seas1 <- snaive(ts_forPE_R_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas1)
plot(SNAIVE_seas1)

#seasonal naive model for energy losses
SNAIVE_seas2 <- snaive(ts_forEL_R_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas2)
plot(SNAIVE_seas2)
```

```{r include=FALSE}
plot(SNAIVE_seas1)
```

```{r include=FALSE}
plot(SNAIVE_seas2)
```


```{r include=FALSE}
## Model 3: SARIMA
##SARIMA model for primary energy consumption
SARIMA_autofit1 <- auto.arima(ts_forPE_R_train)
checkresiduals(SARIMA_autofit1)

SARIMA_for1 <- forecast(SARIMA_autofit1,h=n_for)
plot(SARIMA_for1)

##SARIMA model for energy losses
SARIMA_autofit2 <- auto.arima(ts_forEL_R_train)
checkresiduals(SARIMA_autofit2)

SARIMA_for2 <- forecast(SARIMA_autofit2,h=n_for)
plot(SARIMA_for2)
```

```{r include=FALSE}
plot(SARIMA_for1)
```

```{r include=FALSE}
plot(SARIMA_for2)
```


```{r include=FALSE}
## Fitting State Space Models to the original (seasonal) series
## Model 4: SS Exponential smoothing
##SSEAS model for primary energy consumption
SSES_seas1 <- es(ts_forPE_R_train,model="ZZZ",h=n_for,holdout=FALSE)
plot(SSES_seas1)
checkresiduals(SSES_seas1)

##SSES model for energy losses
SSES_seas2 <- es(ts_forEL_R_train,model="XXX",h=n_for,holdout=FALSE)
plot(SSES_seas2)
checkresiduals(SSES_seas2)
```

```{r include=FALSE}
autoplot(ts_forPE_R_train) +
  autolayer(SSES_seas1$forecast, series="SSES") +
  xlab("Month") + ylab("Primary Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))

```

```{r include=FALSE}
autoplot(ts_forEL_R_train) +
  autolayer(SSES_seas2$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```



```{r include=FALSE}
### Model 5: SS with StructTS()
#For primary energy consumption
SS_seas1 <- StructTS(ts_forPE_R_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas1)

#For energy losses
SS_seas2 <- StructTS(ts_forEL_R_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas2)

#Generating forecasts
SS_for1 <- forecast(SS_seas1,h=n_for)
plot(SS_for1)

SS_for2 <- forecast(SS_seas2,h=n_for)
plot(SS_for2)
```

```{r include=FALSE}
plot(SS_for1)
```

```{r include=FALSE}
plot(SS_for2)
```


```{r include=FALSE}
## Checking accuracy of the five models
#Model 1: Arithmetic mean
MEAN_scores1 <- accuracy(MEAN_seas1$mean,last_forPE_obs_R_test)
MEAN_scores2 <- accuracy(MEAN_seas2$mean,last_EL_obs_R_test)

#Model 2: Seasonal naive 
SNAIVE_scores1 <- accuracy(SNAIVE_seas1$mean,last_forPE_obs_R_test)
SNAIVE_scores2 <- accuracy(SNAIVE_seas2$mean,last_EL_obs_R_test)

# Model 3:  SARIMA 
SARIMA_scores1 <- accuracy(SARIMA_for1$mean,last_forPE_obs_R_test)
SARIMA_scores2 <- accuracy(SARIMA_for2$mean,last_EL_obs_R_test)

# Model 4:  SSES
SSES_scores1 <- accuracy(SSES_seas1$forecast,last_forPE_obs_R_test)
SSES_scores2 <- accuracy(SSES_seas2$forecast,last_EL_obs_R_test)

# Model 5:  BSM 
SS_scores1 <- accuracy(SS_for1$mean,last_forPE_obs_R_test)
SS_scores2 <- accuracy(SS_for2$mean,last_EL_obs_R_test)
```


```{r include=FALSE}
## Compare performance metrics
#create data frame for primary energy consumption
seas_scores1 <- as.data.frame(rbind(MEAN_scores1, SNAIVE_scores1, SARIMA_scores1,SSES_scores1,SS_scores1))
row.names(seas_scores1) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index1_RMSE <- which.min(seas_scores1[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores1[best_model_index1_RMSE,]))        
                            
```

These two following plots of primary energy consumption for the residential sector show a strong relationship and seasonality, with the BSM model performing the best among the five models. The first plot shows the original data from 1973 to 2022, along with the forecasts generated by the five models. The second plot only shows the last three years of the data (2019-2022), along with the same forecasts generated by the five models.

In both plots, the BSM model forecast shows a close fit to the observed data, capturing the strong seasonality and trend in the data. The other models also capture the seasonality to varying degrees, but they may not perform as well in capturing the trend. The MEAN model and the seasonal naive model capture the seasonality but assume a constant mean, which may not be appropriate for data with a trend. The SARIMA and SSES models can capture both seasonality and trend, but they may require more parameter tuning and may be more complex than the BSM model.

### Primary Energy Consumption Plots (1973-2022 vs. 2017-2022)

```{r echo=FALSE}
## Plotting everything together
#Residential Primary Energy
autoplot(ts_electricity_R[,"Primary.Energy"]) +
  autolayer(MEAN_seas1, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for1,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1$forecast, series="SSES") +
  autolayer(SS_for1,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

#Residential Primary Energy - only last five years
autoplot(ts_electricity_R_PE_test) +
  autolayer(MEAN_seas1, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for1,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1$forecast, series="SSES") +
  autolayer(SS_for1,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2019-2022"))
```


```{r echo=FALSE}

kbl_PE_R<-kbl(seas_scores1, 
      caption = "Forecast Accuracy for Residential Primary Energy Consumption's Seasonal Data",
      digits = array(5,ncol(seas_scores1))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores1[,"RMSE"]))

kbl_PE_R
```

After checking five models accuracy, we created a data frame to compare the performance metrics of the five models for primary energy consumption. In this case, the best model by RMSE is the state space model using the basic structural model (BSM). Next, we created a formatted table of the forecast accuracy for the models applied to the primary energy consumption's seasonal data. 

```{r include=FALSE}
### Now Fit Best Model for Residential Sector

#transform to time series data FOR Primary Energy Consumption
ts_electricity_R_entire_Consumption <- ts(
  electricity_consumption_R[,2],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#transform to time series data FOR Energy Losses
ts_electricity_R_entire_Losses <- ts(
  electricity_consumption_R[,3],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#10 year foreacast
n_for2<-120

### Best Model for residential electricity consumption: BSM
BSM_R_PE_entire <- StructTS(ts_electricity_R_entire_Consumption,
                    type="BSM",fixed=c(NA,NA,NA,NA))
BSM_R_PEfor_entire <- forecast(BSM_R_PE_entire,h=n_for2)
plot(BSM_R_PEfor_entire)


##SSEAS model for energy losses for future ten years
SSES_R_EL_entire <- es(ts_electricity_R_entire_Losses,model="XXX",h=n_for2,holdout=FALSE)
plot(SSES_R_EL_entire)


```

```{r echo=FALSE}
#10yrs

autoplot(ts_electricity_R_entire_Consumption) +
  autolayer(BSM_R_PEfor_entire, series="BSM") +
  xlab("Month") + ylab("Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2022-2032"))

```

This plot shows the forecasted primary energy consumption for the entire 50-year period (1973-2032), with the BSM model generating a 10-year forecast (120 periods) for the residential sector. The forecast indicates a continuation of the strong seasonality and trend observed in the historical data, with a slight increase in consumption towards the end of the forecast horizon.

### Energy Loss Plots (1973-2022 vs. 2017-2022)


These following two plots of energy losses for the residential sector show a strong relationship and seasonality, and the SSES model performs the best among the five models. The first plot shows the original data from 1973 to 2022, along with the forecasts generated by the five models. The second plot only shows the last year of the data (2017-2022), along with the same forecasts generated by the five models.

In both plots, the SSES model forecast shows a close fit to the observed data, capturing the strong seasonality and trend in the data. The other models also capture the seasonality to varying degrees, but they may not perform as well in capturing the trend. The MEAN model and the seasonal naive model capture the seasonality but assume a constant mean, which may not be appropriate for data with a trend. The SARIMA and BSM models can capture both seasonality and trend, but they may require more parameter tuning and may be more complex than the SSES model.

```{r echo=FALSE}
#Residential Energy Losses
autoplot(ts_electricity_R[,"Energy.Losses"]) +
  autolayer(MEAN_seas2, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for2,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2$forecast, series="SSES") +
  autolayer(SS_for2,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

#Residential Energy Losses - only last year
autoplot(ts_electricity_R_EL_test) +
  autolayer(MEAN_seas2, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for2,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2$forecast, series="SSES") +
  autolayer(SS_for2,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```



```{r include=FALSE}
#create data frame for residential energy losses
seas_scores2 <- as.data.frame(rbind(MEAN_scores2, SNAIVE_scores2, SARIMA_scores2,SSES_scores2,SS_scores2))
row.names(seas_scores2) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index2_RMSE <- which.min(seas_scores2[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores2[best_model_index2_RMSE,]))      
                            
```




```{r echo=FALSE}

kbl_EL_R<-kbl(seas_scores2, 
      caption = "Forecast Accuracy for Residential Enegy Losses' Seasonal Data",
      digits = array(5,ncol(seas_scores2))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores2[,"RMSE"]))

kbl_EL_R
```

From the Table 3, the SSES model has the smallest RMSE, so we continually fit this model to forecast future 10 years consumption and losses.

```{r echo=FALSE}
#10yrs
autoplot(ts_electricity_R_entire_Losses) +
  autolayer(SSES_R_EL_entire$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2022-2032"))

```

This plot shows the forecasted energy losses for the same 50-year period, with the SSES model generating a 10-year forecast (120 periods) for the residential sector. The forecast indicates a continuation of the strong seasonality and trend observed in the historical data, with a slight increase in losses towards the end of the forecast horizon.

## Commercial Sector

```{r include=FALSE}
# Create a variable with number of steps ahead we will forecast
n_for <- 60

ts_forPE_C_train <- ts(ts_electricity_C[1:(nobs-n_for),"Primary.Energy"],
               start=c(1973,02,01),
               frequency=12)
last_PE_obs_C_test <- ts_electricity_C[(nobs-n_for+1):nobs,"Primary.Energy"] 

ts_forEL_C_train <- ts(ts_electricity_C[1:(nobs-n_for),"Energy.Losses"],
               start=c(1973,02,01),
               frequency=12)
last_EL_obs_C_test <- ts_electricity_C[(nobs-n_for+1):nobs,"Energy.Losses"] 
```


```{r include=FALSE}
##Model 1: Arithmetic mean
#mean model for primary energy consumption
MEAN_seas1_C <- meanf(y = ts_forPE_C_train, h = n_for)  
checkresiduals(MEAN_seas1_C)

#mean model for energy losses
MEAN_seas2_C <- meanf(y = ts_forEL_C_train, h = n_for)  
checkresiduals(MEAN_seas2_C)

```

```{r include=FALSE}
plot(MEAN_seas1_C)
```

```{r include=FALSE}
plot(MEAN_seas2_C)
```

```{r include=FALSE}
## Model 2: Seasonal naive
#seasonal naive model for primary energy consumption
SNAIVE_seas1_C <- snaive(ts_forPE_C_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas1_C)

#seasonal naive model for energy losses
SNAIVE_seas2_C <- snaive(ts_forEL_C_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas2_C)
```

```{r include=FALSE}
plot(SNAIVE_seas1_C)
```

```{r include=FALSE}
plot(SNAIVE_seas2_C)
```


```{r include=FALSE}
## Model 3: SARIMA
##SARIMA model for primary energy consumption
SARIMA_autofit1_C <- auto.arima(ts_forPE_C_train)
checkresiduals(SARIMA_autofit1_C)

SARIMA_for1_C <- forecast(SARIMA_autofit1_C,h=n_for)

##SARIMA model for energy losses
SARIMA_autofit2_C <- auto.arima(ts_forEL_C_train)
checkresiduals(SARIMA_autofit2_C)

SARIMA_for2_C <- forecast(SARIMA_autofit2_C,h=n_for)
plot(SARIMA_for2_C)
```

```{r include=FALSE}
plot(SARIMA_for1_C)
```

```{r include=FALSE}
plot(SARIMA_for2_C)
```


```{r include=FALSE}

## Fitting State Space Models to the original (seasonal) series
## Model 4: SS Exponential smoothing
##SSEAS model for primary energy consumption
SSES_seas1_C <- es(ts_forPE_C_train,model="ZZZ",h=n_for,holdout=FALSE)
checkresiduals(SSES_seas1_C)

##SSEAS model for energy losses
SSES_seas2_C <- es(ts_forEL_C_train,model="XXX",h=n_for,holdout=FALSE)
checkresiduals(SSES_seas2_C)
```

```{r include=FALSE}
autoplot(ts_forPE_C_train) +
  autolayer(SSES_seas1_C$forecast, series="SSES") +
  xlab("Month") + ylab("Primary Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2019-2022"))

```

```{r include=FALSE}
autoplot(ts_forEL_C_train) +
  autolayer(SSES_seas2_C$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```

```{r include=FALSE}
### Model 5: SS with StructTS()
#For primary energy consumption
SS_seas1_C <- StructTS(ts_forPE_C_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas1_C)

#For energy losses
SS_seas2_C<- StructTS(ts_forEL_C_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas2_C)

#Generating forecasts
SS_for1_C <- forecast(SS_seas1_C,h=n_for)

SS_for2_C <- forecast(SS_seas2_C,h=n_for)
```

```{r include=FALSE}
plot(SS_for1_C)
```

```{r include=FALSE}
plot(SS_for2_C)
```

```{r include=FALSE}
## Checking accuracy of the five models
#Model 1: Arithmetic mean
MEAN_scores1_C <- accuracy(MEAN_seas1_C$mean,last_PE_obs_C_test)
MEAN_scores2_C <- accuracy(MEAN_seas2_C$mean,last_EL_obs_C_test)

#Model 2: Seasonal naive 
SNAIVE_scores1_C<- accuracy(SNAIVE_seas1_C$mean,last_PE_obs_C_test)
SNAIVE_scores2_C <- accuracy(SNAIVE_seas2_C$mean,last_EL_obs_C_test)

# Model 3:  SARIMA 
SARIMA_scores1_C <- accuracy(SARIMA_for1_C$mean,last_PE_obs_C_test)
SARIMA_scores2_C <- accuracy(SARIMA_for2_C$mean,last_EL_obs_C_test)

# Model 4:  SSES
SSES_scores1_C <- accuracy(SSES_seas1_C$forecast,last_PE_obs_C_test)
SSES_scores2_C <- accuracy(SSES_seas2_C$forecast,last_EL_obs_C_test)

# Model 5:  BSM 
SS_scores1_C <- accuracy(SS_for1_C$mean,last_PE_obs_C_test)
SS_scores2_C <- accuracy(SS_for2_C$mean,last_EL_obs_C_test)
```

### Primary Energy Consumption Plots (1973-2022 vs. 2017-2022)

These following two plots of primary energy consumption for the residential sector show a strong relationship and seasonality, with the SARIMA model performing the best among the five models. The first plot shows the original data from 1973 to 2022, along with the forecasts generated by the five models. The second plot only shows the last three years of the data (2019-2022), along with the same forecasts generated by the five models. In both plots, the SARIMA model forecast shows a close fit to the observed data, capturing the strong seasonality and trend in the data. The other models also capture the seasonality to varying degrees, but they may not perform as well in capturing the trend. 

```{r echo=FALSE}
## Plotting everything together
#Commercial Primary Energy
autoplot(ts_electricity_C[,"Primary.Energy"]) +
  autolayer(MEAN_seas1_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_C, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for1_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_C$forecast, series="SSES") +
  autolayer(SS_for1_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))
# Only last year
autoplot(ts_electricity_C_PE_test) +
  autolayer(MEAN_seas1_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_C, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for1_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_C$forecast, series="SSES") +
  autolayer(SS_for1_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2019-2022"))
```



```{r include=FALSE}
#create data frame for primary energy consumption
seas_scores1_C <- as.data.frame(rbind(MEAN_scores1_C, SNAIVE_scores1_C, SARIMA_scores1_C,SSES_scores1,SS_scores1_C))
row.names(seas_scores1_C) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index1_C_RMSE <- which.min(seas_scores1_C[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores1_C[best_model_index1_C_RMSE,]))   
      
                            
```

```{r echo=FALSE}
kbl_PE_C<-kbl(seas_scores1_C, 
      caption = "Forecast Accuracy for Commercial Primary Energy Consumption's Seasonal Data",
      digits = array(5,ncol(seas_scores1_C))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores1_C[,"RMSE"]))
kbl_PE_C
```

The SARIMA model has the lowest RMSE, and SNAIVE model has the lowest MAPE. But we use the value of RMSE as the threshold.

```{r include=FALSE}
#Now fit SARIMA (the best model) using the entire dataset for PE consumption in commercial sector

#Create a ts object for the entire PE consumption
ts_electricity_C_PE <- ts(
  electricity_consumption_C[,2],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#For PE energy consumption
SARIMA_entire_PE_C <- auto.arima(ts_electricity_C_PE)
checkresiduals(SARIMA_entire_PE_C)

SARIMA_entire_forecast2_C <- forecast(SARIMA_entire_PE_C,h=120)


#Create a ts object for the entire energy loss
ts_electricity_C_EL <- ts(
  electricity_consumption_C[,3],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)


#For energy loss
##SARIMA model for energy losses for future ten years
SARIMA_entire_EL_C <- auto.arima(ts_electricity_C_EL)
checkresiduals(ts_electricity_C_EL)

SARIMA_entire_forecast3_C <- forecast(SARIMA_entire_EL_C,h=120)

```

```{r echo=FALSE}
#10yrs
autoplot(ts_electricity_C_PE) +
  autolayer(SARIMA_entire_forecast2_C, series="SARIMA") +
  xlab("Month") + ylab("Energy Consumption (Trillion BTU)") +
  theme(plot.margin = margin(2,.8,2,.8, "cm"))+
  guides(colour=guide_legend(title="Forecast 2022-2032"))
```

This plot shows the forecasted primary energy consumption for the entire 50-year period (1973-2032), with the SARIMA model generating a 10-year forecast (120 periods) for the commercial sector. The forecast indicates a continuation of the strong seasonality and trend observed in the historical data, with a significant increase in consumption towards the end of the forecast horizon.

### Energy Loss Plots (1973-2022 vs. 2017-2022)

These two following plots of commercial energy losses show a strong seasonality in the data, with the SARIMA model performing the best among the five models. The first plot shows the original data from 1973 to 2022, along with the forecasts generated by the five models. The second plot only shows the last five years of the data (2017-2022), along with the same forecasts generated by the five models.

In both plots, the SARIMA model forecast shows a close fit to the observed data, capturing the strong seasonality and trend in the data. The other models also capture the seasonality to varying degrees, but they may not perform as well in capturing the trend. 

```{r echo=FALSE}
#Commercial Energy Losses
autoplot(ts_electricity_C[,"Energy.Losses"]) +
  autolayer(MEAN_seas2_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_C, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for2_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_C$forecast, series="SSES") +
  autolayer(SS_for2_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))
#Commercial Energy Losses - only last year
autoplot(ts_electricity_C_EL_test) +
  autolayer(MEAN_seas2_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_C, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for2_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_C$forecast, series="SSES") +
  autolayer(SS_for2_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```



```{r include=FALSE}
seas_scores2_C <- as.data.frame(rbind(MEAN_scores2_C, SNAIVE_scores2_C, SARIMA_scores2_C,SSES_scores2_C,SS_scores2_C))
row.names(seas_scores2_C) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")
#choose model with lowest RMSE
best_model_index2_C_RMSE <- which.min(seas_scores2_C[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores2_C[best_model_index2_C_RMSE,])) 

```

```{r echo=FALSE}
kbl_EL_C<-kbl(seas_scores2_C, 
      caption = "Forecast Accuracy for Commercial Energy Losses' Seasonal Data",
      digits = array(5,ncol(seas_scores2_C))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores2_C[,"RMSE"]))
kbl_EL_C
```

From the Table 5, SARIMA model has both the lowest RMSE and MAPE. Therefore, it is the perfect fitting model to forecast future ten years' variables in the commercial sector.

```{r echo=FALSE}
#10yrs
autoplot(ts_electricity_C_EL) +
  autolayer(SARIMA_entire_forecast3_C, series="SARIMA") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2022-2032"))
```

We create a time series object for the entire energy loss data, fit a SARIMA model to it using the auto.arima() function, check the residuals, and generate a forecast for the next 10 years using the forecast() function.
This plot shows the forecasted energy losses for the same 50-year period, with the SARIMA model generating a 10-year forecast (120 periods) for the commercial sector. The forecast indicates a continuation of the strong seasonality and trend observed in the historical data, with a significant increase in losses towards the end of the forecast horizon.


## Industrial Sector

### Industrial Primary Energy Consumption

First, the primary energy consumption time series data has been fit into the five models for 5 year forecasting from 2017 to 2022 for the testing purpose.  While the MEAN model did not quite work well and showed no forecasting pattern, the other models turned out a messy wavy pattern with great variability. Yet, compared to the original data from 2017 to 2022, the forecasts are not as accurate as we expected. While the forecasts display the same repeating pattern every year in the five years, the actual data has a huge variability. With such big variability, it is hard to demonstrate very accurate forecasting. We determined that the best model for this data is SSES, given the small values of RMSE and MAPE from the accuracy test below.

```{r include=FALSE}
# Create a variable with number of steps ahead we will forecast
n_for <- 60

ts_forPE_I_train <- ts(ts_electricity_I[1:(nobs-n_for),"Primary.Energy"],
                start=c(1973,02,01),
               frequency=12)

last_forPE_obs_I_test <- ts_electricity_I[(nobs-n_for+1):nobs,"Primary.Energy"]

ts_forEL_I_train <- ts(ts_electricity_I[1:(nobs-n_for),"Energy.Losses"],
               start=c(1973,02,01),
               frequency=12)
last_EL_obs_I_test <- ts_electricity_I[(nobs-n_for+1):nobs,"Energy.Losses"]
```

```{r include=FALSE}
## Model 1: Arithmetic mean
#mean model for primary energy consumption
MEAN_seas1_I <- meanf(y = ts_forPE_I_train, h =n_for)  
checkresiduals(MEAN_seas1_I)


#mean model for energy losses
MEAN_seas2_I <- meanf(y = ts_forEL_I_train, h = n_for)  
checkresiduals(MEAN_seas2_I)
plot(MEAN_seas2_I)
```

```{r include=FALSE}
plot(MEAN_seas1_I)
```

```{r include=FALSE}
plot(MEAN_seas2_I)
```

```{r include=FALSE}
## Model 2: Seasonal naive
#seasonal naive model for primary energy consumption
SNAIVE_seas1_I <- snaive(ts_forPE_I_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas1_I)

#seasonal naive model for energy losses
SNAIVE_seas2_I <- snaive(ts_forEL_I_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas2_I)
```

```{r include=FALSE}
plot(SNAIVE_seas1_I)
```

```{r include=FALSE}
plot(SNAIVE_seas2_I)
```

```{r include=FALSE}
## Model 3: SARIMA
##SARIMA model for primary energy consumption
SARIMA_autofit1_I <- auto.arima(ts_forPE_I_train)
checkresiduals(SARIMA_autofit1_I)

SARIMA_for1_I <- forecast(SARIMA_autofit1_I,h=n_for)


##SARIMA model for energy losses
SARIMA_autofit2_I <- auto.arima(ts_forEL_I_train)

SARIMA_for2_I <- forecast(SARIMA_autofit2_I,h=n_for)

```

```{r include=FALSE}
plot(SARIMA_for1_I)
```

```{r include=FALSE}
plot(SARIMA_for2_I)
```

```{r include=FALSE}
## Fitting State Space Models to the original (seasonal) series
## Model 4: SS Exponential smoothing
##SSEAS model for primary energy consumption
SSES_seas1_I <- es(ts_forPE_I_train,model="ZZZ",h=n_for,holdout=FALSE)
plot(SSES_seas1_I)
checkresiduals(SSES_seas1_I)

##SSEAS model for energy losses
SSES_seas2_I <- es(ts_forEL_I_train,model="XXX",h=n_for,holdout=FALSE)
plot(SSES_seas2_I)
checkresiduals(SSES_seas2_I)
```

```{r include=FALSE}
autoplot(ts_forPE_I_train) +
  autolayer(SSES_seas1_I$forecast, series="SSES") +
  xlab("Month") + ylab("Primary Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))

```

```{r include=FALSE}
autoplot(ts_forEL_I_train) +
  autolayer(SSES_seas2_I$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```


```{r include=FALSE}
### Model 5: SS with StructTS()
#For primary energy consumption
SS_seas1_I <- StructTS(ts_forPE_I_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas1_I)

#For energy losses
SS_seas2_I <- StructTS(ts_forEL_I_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas2_I)

#Generating forecasts
SS_for1_I <- forecast(SS_seas1_I,h=n_for)

SS_for2_I <- forecast(SS_seas2_I,h=n_for)

```

```{r include=FALSE}
plot(SS_for1_I)
```

```{r include=FALSE}
plot(SS_for2_I)
```

### Primary Energy Consumption Plots (1973-2022 vs. 2017-2022)

```{r echo=FALSE}
## Plotting everything together
#Industrial Primary Energy
autoplot(ts_electricity_I[,"Primary.Energy"]) +
  autolayer(MEAN_seas1_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_I, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for1_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_I$forecast, series="SSES") +
  autolayer(SS_for1_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))
#Industrial Primary Energy - only last year
autoplot(ts_electricity_I_PE_test) +
  autolayer(MEAN_seas1_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_I, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for1_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_I$forecast, series="SSES") +
  autolayer(SS_for1_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))

```



```{r include=FALSE}
## Checking accuracy of the five models
#Model 1: Arithmetic mean
MEAN_scores1_I <- accuracy(MEAN_seas1_I$mean,last_forPE_obs_I_test)
MEAN_scores2_I <- accuracy(MEAN_seas2_I$mean,last_EL_obs_I_test)

#Model 2: Seasonal naive 
SNAIVE_scores1_I <- accuracy(SNAIVE_seas1_I$mean,last_forPE_obs_I_test)
SNAIVE_scores2_I <- accuracy(SNAIVE_seas2$mean,last_EL_obs_I_test)

# Model 3:  SARIMA 
SARIMA_scores1_I <- accuracy(SARIMA_for1_I$mean,last_forPE_obs_I_test)
SARIMA_scores2_I <- accuracy(SARIMA_for2_I$mean,last_EL_obs_I_test)

# Model 4:  SSES
SSES_scores1_I <- accuracy(SSES_seas1_I$forecast,last_forPE_obs_I_test)
SSES_scores2_I <- accuracy(SSES_seas2_I$forecast,last_EL_obs_I_test)

# Model 5:  BSM 
SS_scores1_I <- accuracy(SS_for1_I$mean,last_forPE_obs_I_test)
SS_scores2_I <- accuracy(SS_for2_I$mean,last_EL_obs_I_test)
```

```{r include=FALSE}
#create data frame for primary energy consumption
seas_scores1_I <- as.data.frame(rbind(MEAN_scores1_I, SNAIVE_scores1_I, SARIMA_scores1_I,SSES_scores1_I,SS_scores1_I))
row.names(seas_scores1_I) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index1_I_RMSE <- which.min(seas_scores1_I[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores1_I[best_model_index1_I_RMSE,]))        
  
                            
```

```{r echo=FALSE}

kbl_PE_I<-kbl(seas_scores1_I, 
      caption = "Forecast Accuracy for Industrial Primary Energy Consumption's Seasonal Data",
      digits = array(5,ncol(seas_scores1_I))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores1_I[,"MAPE"]))

kbl_PE_I
```

Then, hereâ€™s the ten year forecasting for the industrial sector primary energy consumption. SSES model clearly shows the increasing trend of energy consumption in the industrial sector from 2022 to 2032. This can be understood as a sign of expanding electrification in the sector. Compared to the other two sectors, the industrial sector has experienced a rapid installation of electrified machines, energy-intensive manufacturing systems, and increasing production due to growing demand in general. Thus, the primary energy consumption in the industrial sector will likely increase in the next ten years. A possible challenge could be how the sector will accommodate the increasing electricity needs while achieving their carbon emission reduction objectives. 

```{r include=FALSE}
### Fit Best Model 
#Now fit BSM (the best model) using the entire dataset for PE consumption in industrial sector 

#Create a ts object for the entire PE consumption 
ts_electricity_I_PE <- ts(
  electricity_consumption_I[,2],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#For primary energy consumption
SSES_seasforecast_I <- es(ts_electricity_I_PE,model="ZZZ",h=n_for2,holdout=FALSE)
plot(SSES_seasforecast_I)
checkresiduals(SSES_seasforecast_I)

```

```{r echo=FALSE}
autoplot(ts_electricity_I_PE) +
  autolayer(SSES_seasforecast_I$forecast, series="SSES") +
  xlab("Month") + ylab("Primary Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2022-2032"))

```

### Industrial Energy Loss

Second, the energy losses forecasts showed similar results as the energy consumption. BSM, Naive, SARIMA, and SSES models displayed the similar patterns for the 2017-2022, and the MEAN model did not do a good job. The industrial sector energy losses data contain an odd variability which is not quite the same as a simple seasonality. Although the forecast models captured the odd pattern to some extent, the forecast data are not completely matching with the original data. From the accuracy test, we identified the best model for this forecasting is SARIMA as the training SARIMA model had the smallest RMSE and MAPE values. 

```{r echo=FALSE} 
#Industrial Energy Losses
autoplot(ts_electricity_I[,"Energy.Losses"]) +
  autolayer(MEAN_seas2_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_I, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for2_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_I$forecast, series="SSES") +
  autolayer(SS_for2_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))
#Industrial Energy Losses - only last year
autoplot(ts_electricity_I_EL_test) +
  autolayer(MEAN_seas2_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_I, PI=FALSE, series="NaÃ¯ve") +
  autolayer(SARIMA_for2_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_I$forecast, series="SSES") +
  autolayer(SS_for2_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```




```{r include=FALSE}
#create data frame for industrial energy losses
seas_scores2_I <- as.data.frame(rbind(MEAN_scores2_I, SNAIVE_scores2_I, SARIMA_scores2_I,SSES_scores2_I,SS_scores2_I))
row.names(seas_scores2_I) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index2_I_RMSE <- which.min(seas_scores2_I[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores2_I[best_model_index2_I_RMSE,]))      
                            
```

```{r echo=FALSE}

kbl_EL_I<-kbl(seas_scores2_I, 
      caption = "Forecast Accuracy for Industrial Enegy Losses' Seasonal Data",
      digits = array(5,ncol(seas_scores2_I))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores2_I[,"MAPE"]))

kbl_EL_I
```

The 2022-2032 ten year forecasting for the industrial sector energy losses is shown below. In contrast to the energy consumption forecasting, the SARIMA model turns out having a decreasing trend forecasting for the energy losses. Given that the energy losses have been decreasing especially since after 2000, we can assume that increased energy efficiency in the industrial systems have contributed to the decline. Technological advancement in manufacturing energy efficiency has so much potential to reduce the energy losses in the industrial sector. It should be a good incentive for many industrial sector performers to enhance their energy efficiency for more effective use of electricity with lower energy losses. 

```{r include=FALSE}
#Fit SARIMA using the entire dataset for energy loss in industrial sector 

#Create a ts object for the entire energy loss
ts_electricity_I_EL <- ts(
  electricity_consumption_I[,3],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#For energy loss 
SARIMA_entire_EL_I <- auto.arima(ts_electricity_I_EL)
checkresiduals(SARIMA_entire_EL_I)

#Generating forecasts for the next ten years of energy losses
SARIMA_entire_forecast2_I <- forecast(SARIMA_entire_EL_I,h=120)
plot(SARIMA_entire_forecast2_I)
```

```{r echo=FALSE}

autoplot(SARIMA_entire_forecast2_I) +
  xlab("Month") + ylab("Industrial Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2022-2032"))
```

## Best Models' Residuals 1973-2022

The following six figures show residuals of all six best models in three sectors, and they are BSM, SSES, SARIMA, SARIMA, SSES, and SARIMA. It is not hard to tell all residuals indicate nearly normal distributions that they could fit the best forecasting models.

```{r echo=FALSE}
#best models residuals
#Residential sector 1973-2022
checkresiduals(SS_seas1)
checkresiduals(SSES_seas2)

#Commercial sector
checkresiduals(SARIMA_autofit1_C)
checkresiduals(SARIMA_autofit2_C)

#Industrial sector
checkresiduals(SS_seas1_I)
checkresiduals(SARIMA_autofit2_I)
```

## Conclusion
### Limitation

One of the challenges we faced in this study was energy losses forecasting accuracy. For all three sectors, when we ran the 2017-2022 forecast testing, the results were not quite accurate and even showed some patterns in opposite directions. We have tried different testing time frames, before and after the COVID year of 2020, and we ended up using the 2017-2022 5-year testing window because of the better accuracy test results. 

Another limitation is that our models did not consider the impacts from the external factors, such as an economic recession, political disruptions, and pandemics, on the energy consumption and energy losses data. As mentioned in the dataset information description, the industrial sector has been prominently affected by such external factors. In the next ten years, it is hardly possible to predict what will happen in economics and politics. As we have observed, electricity consumption significantly decreased during the early phase of the COVID pandemic, so extraordinary events could disturb the forecast patterns. 

Moreover, the ten-year forecasting for energy consumption in the residential and commercial sectors and the energy losses in the residential sector demonstrate the constant trend. These constant trends are likely stemming from the constant trends in previous years, but that could not be the case for future years. 

All three sectors show perfect performance on our first variable, primary energy consumption, but terrible performance on our second variable, energy losses, especially in the residential and commercial sectors, when we zoom in and make a detailed comparison between forecasts of historical data and the 2017-2022 prediction. Unexpected losses throughout the transmission procedure are most likely to blame for our inability to predict the precise energy loss statistics. Due to its comparatively high voltage requirements, the industrial sector has the shortest path in terms of the transmission process. However, further step-down processes occur in the commercial and residential sectors, which result in significant energy losses. There are two solutions that we could use to further enhance the precision of energy loss predictions: adding exogenous factors and adopting multiple seasonality models.

### Discussion
We can see that the projection for the next ten years differs in three areas depending on several models. This project successfully investigated a variety of models that are appropriate for primary energy use. We came to the conclusion that the SARIMA model outperformed the other models since it accounted for the best model in three forecasts when utilizing performance measures (RMSE, MAPE, MSE, and MPE) as well as a visual comparison. We were able to anticipate the future of two variables, which indicate roughly declining energy losses and rising demands for primary energy consumption. The limits of the two models we choose for future forecasting, as well as those of time series forecasting, must be acknowledged. Nevertheless, many stakeholders and policymakers in the energy and utility sectors can still benefit from anticipating energy usage and losses. We can anticipate that energy use will decline in the near future as a result of increased energy awareness and technical improvements that will reduce energy losses.



