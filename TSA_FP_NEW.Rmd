---
title: "TSA_FinalProject_Coding"
Group: Haru, Miaojun, Lynn
output:
  pdf_document: default
  html_document: default
date: "2023-03-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Introduction and Objectives
Energy consumption is a critical indicator for policymakers, industry stakeholders, and researchers to develop effective energy policies and solutions for an effective use of electricity and power loss reduction. However, accurately forecasting and analyzing energy consumption data can be challenging to obtain, as most data are preliminary and subject to revision.

In this project, we will use time series analysis in R to forecast and analyze energy consumption data for three sectors: residential, commercial, and industrial, in the United States, from February 1973 to November 2022. Motivated by the importance of accurate and reliable energy consumption data, this project aims to contribute to a better understanding of energy trends and help inform policy and decision-making in the energy sector. By forecasting and analyzing the EIA’s data on residential, commercial, and industrial uses, we hope to shed light on the drivers of energy consumption in these sectors and identify potential opportunities for reducing energy consumption and improving energy efficiency. 

Moreover, in the time range of February 1973 to November 2022, the United States has experienced a number of political and natural disturbances, such as recessions, pandemics, and natural disasters. Those external factors frequently have an impact on electricity consumption. Then this project aims to explore the impacts of external disturbances on energy consumption in each sector. Forecasting the energy consumption could help ensure the reliability of the energy needs in each sector amid the turmoil and further seek the potential use of emerging technologies such as energy storage in the respective sector. 

Objectives
The objective of this study is to analyze: 
  (1) Effective use of electricity in the residential, commercial, and industrial sectors while considering the energy loss data
  (2) How energy consumption gets affected by natural and political disturbances in each sector 
  (3) Potential in the use of energy technologies, such as electricity storage, by the sectors

```{r package, message=FALSE, warning=FALSE, include=FALSE}
## install packages
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(kableExtra)
library(knitr)
library(forecast)

```

## Dataset Information
The Energy Information Administration (EIA) is the best source of energy data in the United States. It puts out detailed monthly and annual reports on energy production, consumption, stocks, trade, and the effects of different energy sources on the environment. The dataset on energy consumption by the three sectors of residential, commercial, and industrial, covering the period from February 1973 to November 2022, has been selected for analysis for the purposes of this study. This data set has five metrics for each sector, including total energy consumption, end-use energy consumption, energy losses in the electrical system, and primary energy consumption. In order to better understand the patterns of electricity use and energy efficiency in the three sectors, our study focuses on two variables: primary energy consumption and energy losses. Most energy sources, including coal, natural gas, petroleum, geothermal, solar, and biomass, are included in primary energy consumption.
Overall, the following steps were applied to our dataset:
  (1) Download the dataset from EIA.
  (2) Import the dataset to R and delete the unit column.
  (3) Keep two variables for three sectors.
  (4) Convert the dataset from characters to numerical.
  (5) Round all numbers to three decimal places.
  (6) Create a date's data frame.
  (7) Convert the original dataset into time series data for forecasting and summarize it.
  (8) Calculate the mean, standard deviation, maximum values, minimum values, and ranges for primary energy consumption and electrical losses in three sectors.
  (9) Make a summary statistics table.
  (10) Utilize ggplot() to compare three sectors using two initial plots that are variable-classified.


```{r message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
#Import the excel file
library(readxl)
electricity_consumption <- read_excel(path="./Table_2.1a__Energy_Consumption__Residential_-_Commercial_-_and_Industrial_Sectors.xlsx",skip = 10, sheet="Monthly Data",col_names=TRUE) 

#delete the first row with units
electricity_consumption<-electricity_consumption[-1,]

#Keep two columns: primary energy consumption and energy losses for three sectors, respectively
electricity_consumption<-electricity_consumption[,-3][,-3][,-4]
electricity_consumption<-electricity_consumption[,-5][,-5][,-6]
electricity_consumption<-electricity_consumption[,-7][,-7][,-8]

#Round to three digits for all columns
class(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
electricity_consumption$`Primary Energy Consumed by the Residential Sector` <- as.numeric(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
round(electricity_consumption$`Primary Energy Consumed by the Residential Sector`,digits=3)

class(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
electricity_consumption$`Residential Sector Electrical System Energy Losses` <- as.numeric(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
round(electricity_consumption$`Residential Sector Electrical System Energy Losses`,digits=3)

class(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
electricity_consumption$`Primary Energy Consumed by the Commercial Sector` <- as.numeric(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
round(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`,digits=3)

class(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
electricity_consumption$`Commercial Sector Electrical System Energy Losses` <- as.numeric(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
round(electricity_consumption$`Commercial Sector Electrical System Energy Losses`,digits=3)

class(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
electricity_consumption$`Primary Energy Consumed by the Industrial Sector` <- as.numeric(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
round(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`,digits=3)

class(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
electricity_consumption$`Industrial Sector Electrical System Energy Losses` <- as.numeric(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
round(electricity_consumption$`Industrial Sector Electrical System Energy Losses`,digits=3)

colnames(electricity_consumption)<-c('Date','Residential.Primary.Energy','Residential.Energy.Losses','Commercial.Primary.Energy','Commercial.Energy.Losses','Industrial.Primary.Energy','Industrial.Energy.Losses')

head(electricity_consumption)
tail(electricity_consumption)
```



```{r message=FALSE, warning=FALSE, Include=FALSE, echo=FALSE}
#Transform to time series data
Date_frame<-as.Date(electricity_consumption$Month)
ts_electricity <- ts(electricity_consumption[,2:7],start=c(1973,01),end=c(2022,11),frequency=12)

#Summary of time series data
summary_data<-summary(ts_electricity)
summary_data

#Calculate means, standard deviations, and ranges for each variable

mean_R1<-mean(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
sd_R1<-sd(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
max_R1<-max(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
min_R1<-min(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)
range_R1<-max(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)-min(electricity_consumption$`Primary Energy Consumed by the Residential Sector`)

mean_R2<-mean(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
sd_R2<-sd(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
max_R2<-max(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
min_R2<-min(electricity_consumption$`Residential Sector Electrical System Energy Losses`)
range_R2<-max(electricity_consumption$`Residential Sector Electrical System Energy Losses`)-min(electricity_consumption$`Residential Sector Electrical System Energy Losses`)

mean_C1<-mean(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
sd_C1<-sd(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
max_C1<- max(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
min_C1<- min(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)
range_C1<-max(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)-min(electricity_consumption$`Primary Energy Consumed by the Commercial Sector`)

mean_C2<-mean(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
sd_C2<-sd(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
max_C2<- max(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
min_C2<- min(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)
range_C2<-max(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)-min(electricity_consumption$`Commercial Sector Electrical System Energy Losses`)

mean_I1<-mean(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
sd_I1<-sd(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
max_I1<-max(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
min_I1<-min(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)
range_I1<-max(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)-min(electricity_consumption$`Primary Energy Consumed by the Industrial Sector`)

mean_I2<-mean(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
sd_I2<-sd(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
max_I2<-max(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
min_I2<-min(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)
range_I2<-max(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)-min(electricity_consumption$`Industrial Sector Electrical System Energy Losses`)

# Create a table
summary_df <- data.frame(
  Variable = c("Residential_Sector_Consumption", "Residential_Sector_Losses", "Commercial_Sector_Consumption", "Commercial_Sector_Losses", "Industrial_Sector_Consumption", "Industrial_Sector_Losses"),
  Mean = c(584.60,662.45,345.14,605.47,1806.54,576.51),
  StandardDeviation = c(321.54,185.03,146.90,178.14,146.71,68.86),
  Max = c(1488.0, 1144.8,703.6,982.2,2267,776.8),
  Min = c(192.3,325.3,165.3,258.2,1466,405.0),
  Range = c(1295.71,819.46,538.31,723.97,800.93,371.76)
)
  

```
The following table and figures are visualized here:
```{r message=FALSE, warning=FALSE, echo=FALSE}
summary_table<-kbl(summary_df, caption="Table 1. Summary Statistics Table used with ts() function") %>% 
  kable_styling(full_width = FALSE, position = "center",latex_options = "hold_position")
summary_table
```

The industrial sector has the highest average consumption (1806.54 trillion BTU) when comparing primary electrical consumption across the three sectors (Table 1). Despite the similar average energy losses across all three sectors, the residential sector nevertheless suffers from the highest energy losses as a result of overcoming transmission line resistance.
The residential sector has the highest primary electricity consumption, whereas the industrial sector has the lowest energy losses, according to a comparison of standard deviations that we also conducted.
The ranges show the fundamental seasonal shifts over the last few decades. For primary electricity consumption, the residential sector has the strongest seasonality, while the industrial sector exhibits the least seasonality.


```{r, echo=FALSE}
## Initial Plots
#plot for electricity consumption
cols<-c("residential"="orange","commercial"="steelblue","industrial"="yellow")
ts_plot<-ggplot(electricity_consumption)+
  geom_line(aes(x=Date,y=Residential.Primary.Energy,color="residential"))+
  ylab(paste0("Electricity Consumption (Trillion BTU)",sep="")) +
  xlab("Date")+
  geom_line(aes(x=Date,y=Commercial.Primary.Energy,color="commercial"))+
  geom_line(aes(x=Date,y=Industrial.Primary.Energy,color="industrial"))+
  labs(title="Figure 1. Primary Electricity Consumption of Three Sectors")+
  scale_color_manual(name="series",values = cols)
plot(ts_plot)
          
#plot for energy losses
cols1<-c("residential"="green","commercial"="red","industrial"="blue")
ts_plot1<-ggplot(electricity_consumption)+
  geom_line(aes(x=Date,y=Residential.Energy.Losses,color="residential"))+
  ylab(paste0("Energy Losses (Trillion BTU)",sep="")) +
  xlab("Date")+
  geom_line(aes(x=Date,y=Commercial.Energy.Losses,color="commercial"))+
  geom_line(aes(x=Date,y=Industrial.Energy.Losses,color="industrial"))+
  labs(title="Figure 2. Energy Losses of Three Sectors")+
  scale_color_manual(name="series",values = cols1)
plot(ts_plot1)

```
The highest primary energy consumption in Figure 1 is in the industrial sector. Although there is the most seasonality in the residential sector, the commercial sector uses the least primary energy. Strong seasonality is typically more pronounced in the residential and industrial sectors in the summer and winter but less pronounced in the spring and fall. In general, residential and commercial sector patterns are nearly stable; however, exogenous influences throughout time cause the industrial sector to experience increasing and declining trends.
In contrast to the commercial and residential sectors in Figure 2, the electrical losses in the industrial sectors are decreasing. In three sectors, electricity losses are highest in the residential sector while being lowest in the industrial sector. Three industries saw an increasing tendency in energy losses prior to 2000, but after that year, they saw decreasing trends.

We initially build three sub-data frames containing the two variables primary electricity consumption and energy losses for each of the three sectors. All data were converted to time series data. To compute five one seasonality models, forecast consumption and losses from 2017 to 2022, and determine the most effective forecasting models for the next 10 years, all three sectors also contain one testing dataset and one training dataset between 1973 and 2017.


```{r message=FALSE, warning=FALSE, Include=FALSE, echo=FALSE}
###Residential Sector
#Create a dataframe only for Residential
electricity_consumption_R<-electricity_consumption[,-4:-7]
colnames(electricity_consumption_R)<-c('Date','Primary.Energy','Energy.Losses')

#Inspect data
#head(electricity_price)
nvar <- ncol(electricity_consumption_R) - 1
nobs <- nrow(electricity_consumption_R)

#transform to time series data
ts_electricity_R <- ts(
  electricity_consumption_R[,2:(nvar+1)],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_R_PE_test <- ts(
  electricity_consumption_R[,2],
  start=c(2017,11,01),end=c(2022,11,01),
  frequency=12)


ts_electricity_R_EL_test <- ts(
  electricity_consumption_R[,3],
  start=c(2017,11,01),end=c(2022,11,01),
  frequency=12)

```

```{r message=FALSE, warning=FALSE, Include=FALSE, echo=FALSE}
# Create a variable with number of steps ahead we will forecast
#Three years as test variable
n_for <- 60

ts_forPE_R_train <- ts(ts_electricity_R[1:(nobs-n_for),"Primary.Energy"],
                start=c(1973,02,01),end=c(2017,11,01),
               frequency=12)

last_forPE_obs_R_test <- ts_electricity_R[(nobs-n_for+1):nobs,"Primary.Energy"]

ts_last_forPE_obs_R_test <- ts(last_forPE_obs_R_test)

ts_forEL_R_train <- ts(ts_electricity_R[1:(nobs-n_for),"Energy.Losses"],
               start=c(1973,02,01),end=c(2017,11,01),
               frequency=12)
last_EL_obs_R_test <- ts_electricity_R[(nobs-n_for+1):nobs,"Energy.Losses"]


```

```{r include=FALSE}
###Commercial
#Create a dataframe only for Residential
electricity_consumption_C<-electricity_consumption[c(1,4,5)]
colnames(electricity_consumption_C)<-c('Date','Primary.Energy','Energy.Losses')

#Inspect data
#head(electricity_price)
nvar <- ncol(electricity_consumption_C) - 1
nobs <- nrow(electricity_consumption_C)

#transform to time series data
ts_electricity_C <- ts(
  electricity_consumption_C[,2:(nvar+1)],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_C_PE_test <- ts(
  electricity_consumption_C[,2],
  start=c(2017,11,01),end=c(2022,11,01),
  frequency=12)


ts_electricity_C_EL_test <- ts(
  electricity_consumption_C[,3],
  start=c(2017,11,01),end=c(2022,11,01),
  frequency=12)

```

```{r include=FALSE}
###Industrial
#Create a dataframe only for Industrial
electricity_consumption_I<-electricity_consumption[c(1,6,7)]
colnames(electricity_consumption_I)<-c('Date','Primary.Energy','Energy.Losses')

#Inspect data
#head(electricity_price)
nvar <- ncol(electricity_consumption_I) - 1
nobs <- nrow(electricity_consumption_I)
#transform to time series
ts_electricity_I <- ts(
  electricity_consumption_I[,2:(nvar+1)],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_I_PE_test <- ts(
  electricity_consumption_I[,2],
  start=c(2017,11,01),end=c(2022,11,01),
  frequency=12)

ts_electricity_I_EL_test <- ts(
  electricity_consumption_I[,3],
  start=c(2017,11,01),end=c(2022,11,01),
  frequency=12)

```

Before running a time series forecast model and selecting models for time series forecasting, we examine ACF and PACF plots of the original, un-transformed time series (shown below).
```{r echo=FALSE}
#ACF and PACF plots for primary energy consumption
par(mfrow=c(1,6))
ACF_Plot1 <- Acf(electricity_consumption_R$Primary.Energy, lag = 30, plot = TRUE,main="Residential ACF")
PACF_Plot1 <- Pacf(electricity_consumption_R$Primary.Energy, lag = 30, plot = TRUE,main="Residential PACF")
ACF_Plot2 <- Acf(electricity_consumption_C$Primary.Energy, lag = 30, plot = TRUE,main="Commercial ACF")
PACF_Plot2 <- Pacf(electricity_consumption_C$Primary.Energy, lag = 30, plot = TRUE,main="Commercial PACF")
ACF_Plot3 <- Acf(electricity_consumption_I$Primary.Energy, lag = 30, plot = TRUE,main="Industrial ACF")
PACF_Plot3 <- Pacf(electricity_consumption_I$Primary.Energy, lag = 30, plot = TRUE,main="Industrial PACF")

```
For our first variable--primary energy consumption, both ACF and PACF not only show strong seasonality but also non-stationary due to slow decays.
```{r echo=FALSE}
#ACF and PACF plots for energy losses

par(mfrow=c(1,6))
ACF_Plot1 <- Acf(electricity_consumption_R$Energy.Losses, lag = 30, plot = TRUE,main="Residential ACF")
PACF_Plot1 <- Pacf(electricity_consumption_R$Energy.Losses, lag = 30, plot = TRUE,main="Residential PACF")
ACF_Plot2 <- Acf(electricity_consumption_C$Energy.Losses, lag = 30, plot = TRUE,main="Commercial ACF")
PACF_Plot2 <- Pacf(electricity_consumption_C$Energy.Losses, lag = 30, plot = TRUE,main="Commercial PACF")
ACF_Plot3 <- Acf(electricity_consumption_I$Energy.Losses, lag = 30, plot = TRUE,main="Industrial ACF")
PACF_Plot3 <- Pacf(electricity_consumption_I$Energy.Losses, lag = 30, plot = TRUE,main="Industrial PACF")
```
For our second variable--energy loss, both ACF and PACF still show significant values beyond thresholds, especially at lags=12 and 24.

## Analysis (Methods and Models)


```{r include=FALSE}
## Model 1: Arithmetic mean
#mean model for primary energy consumption
MEAN_seas1 <- meanf(y = ts_forPE_R_train, h = n_for)  
checkresiduals(MEAN_seas1)


#mean model for energy losses
MEAN_seas2 <- meanf(y = ts_forEL_R_train, h = n_for)  
checkresiduals(MEAN_seas2)

```

```{r echo=FALSE}
plot(MEAN_seas1)
```

```{r echo=FALSE}
plot(MEAN_seas2)
```


```{r include=FALSE}
## Model 2: Seasonal naive
#seasonal naive model for primary energy consumption
SNAIVE_seas1 <- snaive(ts_forPE_R_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas1)
plot(SNAIVE_seas1)

#seasonal naive model for energy losses
SNAIVE_seas2 <- snaive(ts_forEL_R_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas2)
plot(SNAIVE_seas2)
```

```{r echo=FALSE}
plot(SNAIVE_seas1)
```

```{r echo=FALSE}
plot(SNAIVE_seas2)
```


```{r include=FALSE}
## Model 3: SARIMA
##SARIMA model for primary energy consumption
SARIMA_autofit1 <- auto.arima(ts_forPE_R_train)
checkresiduals(SARIMA_autofit1)

SARIMA_for1 <- forecast(SARIMA_autofit1,h=n_for)
plot(SARIMA_for1)

##SARIMA model for energy losses
SARIMA_autofit2 <- auto.arima(ts_forEL_R_train)
checkresiduals(SARIMA_autofit2)

SARIMA_for2 <- forecast(SARIMA_autofit2,h=n_for)
plot(SARIMA_for2)
```

```{r echo=FALSE}
plot(SARIMA_for1)
```

```{r echo=FALSE}
plot(SARIMA_for2)
```


```{r include=FALSE}
## Fitting State Space Models to the original (seasonal) series
## Model 4: SS Exponential smoothing
##SSEAS model for primary energy consumption
SSES_seas1 <- es(ts_forPE_R_train,model="ZZZ",h=n_for,holdout=FALSE)
plot(SSES_seas1)
checkresiduals(SSES_seas1)

##SSEAS model for energy losses
SSES_seas2 <- es(ts_forEL_R_train,model="XXX",h=n_for,holdout=FALSE)
plot(SSES_seas2)
checkresiduals(SSES_seas2)
```

```{r echo=FALSE}
autoplot(ts_forPE_R_train) +
  autolayer(SSES_seas1$forecast, series="SSES") +
  xlab("Month") + ylab("Primary Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))

```

```{r echo=FALSE}
autoplot(ts_forEL_R_train) +
  autolayer(SSES_seas2$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```



```{r include=FALSE}
### Model 5: SS with StructTS()
#For primary energy consumption
SS_seas1 <- StructTS(ts_forPE_R_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas1)

#For energy losses
SS_seas2 <- StructTS(ts_forEL_R_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas2)

#Generating forecasts
SS_for1 <- forecast(SS_seas1,h=n_for)
plot(SS_for1)

SS_for2 <- forecast(SS_seas2,h=n_for)
plot(SS_for2)
```

```{r echo=FALSE}
plot(SS_for1)
```

```{r echo=FALSE}
plot(SS_for2)
```


```{r include=FALSE}
## Checking accuracy of the five models
#Model 1: Arithmetic mean
MEAN_scores1 <- accuracy(MEAN_seas1$mean,last_forPE_obs_R_test)
MEAN_scores2 <- accuracy(MEAN_seas2$mean,last_EL_obs_R_test)

#Model 2: Seasonal naive 
SNAIVE_scores1 <- accuracy(SNAIVE_seas1$mean,last_forPE_obs_R_test)
SNAIVE_scores2 <- accuracy(SNAIVE_seas2$mean,last_EL_obs_R_test)

# Model 3:  SARIMA 
SARIMA_scores1 <- accuracy(SARIMA_for1$mean,last_forPE_obs_R_test)
SARIMA_scores2 <- accuracy(SARIMA_for2$mean,last_EL_obs_R_test)

# Model 4:  SSES
SSES_scores1 <- accuracy(SSES_seas1$forecast,last_forPE_obs_R_test)
SSES_scores2 <- accuracy(SSES_seas2$forecast,last_EL_obs_R_test)

# Model 5:  BSM 
SS_scores1 <- accuracy(SS_for1$mean,last_forPE_obs_R_test)
SS_scores2 <- accuracy(SS_for2$mean,last_EL_obs_R_test)
```


```{r include=FALSE}
## Compare performance metrics
#create data frame for primary energy consumption
seas_scores1 <- as.data.frame(rbind(MEAN_scores1, SNAIVE_scores1, SARIMA_scores1,SSES_scores1,SS_scores1))
row.names(seas_scores1) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index1_RMSE <- which.min(seas_scores1[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores1[best_model_index1_RMSE,]))        
                            
```

```{r echo=FALSE}

kbl_PE_R<-kbl(seas_scores1, 
      caption = "Forecast Accuracy for Residential Primary Energy Consumption's Seasonal Data",
      digits = array(5,ncol(seas_scores1))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores1[,"RMSE"]))

kbl_PE_R
```

```{r include=FALSE}
#create data frame for residential energy losses
seas_scores2 <- as.data.frame(rbind(MEAN_scores2, SNAIVE_scores2, SARIMA_scores2,SSES_scores2,SS_scores2))
row.names(seas_scores2) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index2_RMSE <- which.min(seas_scores2[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores2[best_model_index2_RMSE,]))      
                            
```

```{r echo=FALSE}

kbl_EL_R<-kbl(seas_scores2, 
      caption = "Forecast Accuracy for Residential Enegy Losses' Seasonal Data",
      digits = array(5,ncol(seas_scores2))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores2[,"RMSE"]))

kbl_EL_R
```


```{r echo=FALSE}
## Plotting everything together
#Residential Primary Energy
autoplot(ts_electricity_R[,"Primary.Energy"]) +
  autolayer(MEAN_seas1, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for1,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1$forecast, series="SSES") +
  autolayer(SS_for1,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

#Residential Primary Energy - only last year
autoplot(ts_electricity_R_PE_test) +
  autolayer(MEAN_seas1, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for1,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1$forecast, series="SSES") +
  autolayer(SS_for1,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2019-2022"))
```

```{r echo=FALSE}
#Residential Energy Losses
autoplot(ts_electricity_R[,"Energy.Losses"]) +
  autolayer(MEAN_seas2, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for2,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2$forecast, series="SSES") +
  autolayer(SS_for2,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

#Residential Energy Losses - only last year
autoplot(ts_electricity_R_EL_test) +
  autolayer(MEAN_seas2, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for2,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2$forecast, series="SSES") +
  autolayer(SS_for2,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))

```

```{r include=FALSE}
### Now Fit Best Model for Residential Sector
#Now fit SSES (the best model) using the entire data set for PE consumption in residential sector

#transform to time series data FOR Primary Energy Consumption
ts_electricity_R_entire_Consumption <- ts(
  electricity_consumption_R[,2],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#transform to time series data FOR Energy Losses
ts_electricity_R_entire_Losses <- ts(
  electricity_consumption_R[,3],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#SSES forecast for both variables in residential sector
##SSEAS model for primary energy consumption for future ten years
n_for2<-120
SARIMA_autofit1for <- auto.arima(ts_electricity_R_entire_Consumption)
checkresiduals(SARIMA_autofit1for)

SARIMA_for3 <- forecast(SARIMA_autofit1for,h=n_for)
plot(SARIMA_for3)

##SSEAS model for energy losses for future ten years
SSES_seas4 <- es(ts_electricity_R_entire_Losses,model="XXX",h=n_for2,holdout=FALSE)
checkresiduals(SSES_seas4)


```

```{r echo=FALSE}
#10years
plot(SARIMA_for3)
```

```{r echo=FALSE}
#10yrs
autoplot(ts_electricity_R_entire_Losses) +
  autolayer(SSES_seas4$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2022-2032"))
```


###Commercial Sector

```{r include=FALSE}
# Create a variable with number of steps ahead we will forecast
n_for <- 60

ts_forPE_C_train <- ts(ts_electricity_C[1:(nobs-n_for),"Primary.Energy"],
               start=c(1973,02,01),end=c(2017,11,01),
               frequency=12)
last_PE_obs_C_test <- ts_electricity_C[(nobs-n_for+1):nobs,"Primary.Energy"] 

ts_forEL_C_train <- ts(ts_electricity_C[1:(nobs-n_for),"Energy.Losses"],
               start=c(1973,02,01),
               frequency=12)
last_EL_obs_C_test <- ts_electricity_C[(nobs-n_for+1):nobs,"Energy.Losses"] 
```



## Model 1: Arithmetic mean
```{r include=FALSE}
#mean model for primary energy consumption
MEAN_seas1_C <- meanf(y = ts_forPE_C_train, h = n_for)  
checkresiduals(MEAN_seas1_C)

#mean model for energy losses
MEAN_seas2_C <- meanf(y = ts_forEL_C_train, h = n_for)  
checkresiduals(MEAN_seas2_C)

```

```{r echo=FALSE}
plot(MEAN_seas1_C)
```

```{r echo=FALSE}
plot(MEAN_seas2_C)
```

## Model 2: Seasonal naive
```{r include=FALSE}
#seasonal naive model for primary energy consumption
SNAIVE_seas1_C <- snaive(ts_forPE_C_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas1_C)

#seasonal naive model for energy losses
SNAIVE_seas2_C <- snaive(ts_forEL_C_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas2_C)
```

```{r echo=FALSE}
plot(SNAIVE_seas1_C)
```

```{r echo=FALSE}
plot(SNAIVE_seas2_C)
```


## Model 3: SARIMA
```{r include=FALSE}
##SARIMA model for primary energy consumption
SARIMA_autofit1_C <- auto.arima(ts_forPE_C_train)
checkresiduals(SARIMA_autofit1_C)

SARIMA_for1_C <- forecast(SARIMA_autofit1_C,h=n_for)

##SARIMA model for energy losses
SARIMA_autofit2_C <- auto.arima(ts_forEL_C_train)
checkresiduals(SARIMA_autofit2_C)

SARIMA_for2_C <- forecast(SARIMA_autofit2_C,h=n_for)
plot(SARIMA_for2_C)
```

```{r echo=FALSE}
plot(SARIMA_for1_C)
```

```{r echo=FALSE}
plot(SARIMA_for2_C)
```


## Fitting State Space Models to the original (seasonal) series
## Model 4: SS Exponential smoothing

```{r include=FALSE}
##SSEAS model for primary energy consumption
SSES_seas1_C <- es(ts_forPE_C_train,model="ZZZ",h=n_for,holdout=FALSE)
checkresiduals(SSES_seas1_C)

##SSEAS model for energy losses
SSES_seas2_C <- es(ts_forEL_C_train,model="XXX",h=n_for,holdout=FALSE)
checkresiduals(SSES_seas2_C)
```

```{r echo=FALSE}
autoplot(ts_forPE_C_train) +
  autolayer(SSES_seas1_C$forecast, series="SSES") +
  xlab("Month") + ylab("Primary Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2019-2022"))

```

```{r echo=FALSE}
autoplot(ts_forEL_C_train) +
  autolayer(SSES_seas2_C$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```



### Model 5: SS with StructTS()


```{r include=FALSE}
#For primary energy consumption
SS_seas1_C <- StructTS(ts_forPE_C_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas1_C)

#For energy losses
SS_seas2_C<- StructTS(ts_forEL_C_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas2_C)

#Generating forecasts
SS_for1_C <- forecast(SS_seas1_C,h=n_for)

SS_for2_C <- forecast(SS_seas2_C,h=n_for)
```

```{r echo=FALSE}
plot(SS_for1_C)
```

```{r echo=FALSE}
plot(SS_for2_C)
```


## Checking accuracy of the five models

```{r include=FALSE}
#Model 1: Arithmetic mean
MEAN_scores1_C <- accuracy(MEAN_seas1_C$mean,last_PE_obs_C_test)
MEAN_scores2_C <- accuracy(MEAN_seas2_C$mean,last_EL_obs_C_test)

#Model 2: Seasonal naive 
SNAIVE_scores1_C<- accuracy(SNAIVE_seas1_C$mean,last_PE_obs_C_test)
SNAIVE_scores2_C <- accuracy(SNAIVE_seas2_C$mean,last_EL_obs_C_test)

# Model 3:  SARIMA 
SARIMA_scores1_C <- accuracy(SARIMA_for1_C$mean,last_PE_obs_C_test)
SARIMA_scores2_C <- accuracy(SARIMA_for2_C$mean,last_EL_obs_C_test)

# Model 4:  SSES
SSES_scores1_C <- accuracy(SSES_seas1_C$forecast,last_PE_obs_C_test)
SSES_scores2_C <- accuracy(SSES_seas2_C$forecast,last_EL_obs_C_test)

# Model 5:  BSM 
SS_scores1_C <- accuracy(SS_for1_C$mean,last_PE_obs_C_test)
SS_scores2_C <- accuracy(SS_for2_C$mean,last_EL_obs_C_test)
```

```{r include=FALSE}
#create data frame for primary energy consumption
seas_scores1_C <- as.data.frame(rbind(MEAN_scores1_C, SNAIVE_scores1_C, SARIMA_scores1_C,SSES_scores1,SS_scores1_C))
row.names(seas_scores1_C) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index1_C_RMSE <- which.min(seas_scores1_C[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores1_C[best_model_index1_C_RMSE,]))   
      
                            
```

```{r echo=FALSE}
kbl_PE_C<-kbl(seas_scores1_C, 
      caption = "Forecast Accuracy for Commercial Primary Energy Consumption's Seasonal Data",
      digits = array(5,ncol(seas_scores1_C))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores1_C[,"RMSE"]))
kbl_PE_C
```
```{r include=FALSE}
seas_scores2_C <- as.data.frame(rbind(MEAN_scores2_C, SNAIVE_scores2_C, SARIMA_scores2_C,SSES_scores2_C,SS_scores2_C))
row.names(seas_scores2_C) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")
#choose model with lowest RMSE
best_model_index2_C_RMSE <- which.min(seas_scores2_C[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores2_C[best_model_index2_C_RMSE,])) 

```

```{r echo=FALSE}
kbl_EL_C<-kbl(seas_scores2_C, 
      caption = "Forecast Accuracy for Commercial Energy Losses' Seasonal Data",
      digits = array(5,ncol(seas_scores2_C))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores2_C[,"RMSE"]))
kbl_EL_C
```

```{r echo=FALSE}
## Plotting everything together
#Commercial Primary Energy
autoplot(ts_electricity_C[,"Primary.Energy"]) +
  autolayer(MEAN_seas1_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_C, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for1_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_C$forecast, series="SSES") +
  autolayer(SS_for1_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

# Only last year
autoplot(ts_electricity_C_PE_test) +
  autolayer(MEAN_seas1_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_C, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for1_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_C$forecast, series="SSES") +
  autolayer(SS_for1_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2019-2022"))
```

```{r echo=FALSE}
#Commercial Energy Losses
autoplot(ts_electricity_C[,"Energy.Losses"]) +
  autolayer(MEAN_seas2_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_C, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for2_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_C$forecast, series="SSES") +
  autolayer(SS_for2_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

#Commercial Energy Losses - only last year
autoplot(ts_electricity_C_EL_test) +
  autolayer(MEAN_seas2_C, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_C, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for2_C,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_C$forecast, series="SSES") +
  autolayer(SS_for2_C,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```

```{r include=FALSE}
#Now fit SARIMA (the best model) using the entire dataset for PE consumption in commercial sector

#Create a ts object for the entire PE consumption
ts_electricity_C_PE <- ts(
  electricity_consumption_C[,2],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#For PE energy consumption
SARIMA_entire_PE_C <- auto.arima(ts_electricity_C_PE)
checkresiduals(SARIMA_entire_PE_C)

SARIMA_entire_forecast2_C <- forecast(SARIMA_entire_PE_C,h=120)


#Fit SSES using the entire dataset for energy loss in commercial sector

#Create a ts object for the entire energy loss
ts_electricity_C_EL <- ts(
  electricity_consumption_C[,3],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)


#For energy loss
##SARIMA model for energy losses for future ten years
SARIMA_entire_EL_C <- auto.arima(ts_electricity_C_EL)
checkresiduals(ts_electricity_C_EL)

SARIMA_entire_forecast3_C <- forecast(SARIMA_entire_EL_C,h=120)

```


```{r echo=FALSE}
#10yrs
plot(SARIMA_entire_forecast2_C)
```

```{r echo=FALSE}
#10yrs
plot(SARIMA_entire_forecast3_C)
```


### Industrial Sector

```{r include=FALSE}
# Create a variable with number of steps ahead we will forecast
n_for <- 60

ts_forPE_I_train <- ts(ts_electricity_I[1:(nobs-n_for),"Primary.Energy"],
                start=c(1973,02,01),end=c(2017,11,01),
               frequency=12)

last_forPE_obs_I_test <- ts_electricity_I[(nobs-n_for+1):nobs,"Primary.Energy"]

ts_forEL_I_train <- ts(ts_electricity_I[1:(nobs-n_for),"Energy.Losses"],
               start=c(1973,02,01),end=c(2017,11,01),
               frequency=12)
last_EL_obs_I_test <- ts_electricity_I[(nobs-n_for+1):nobs,"Energy.Losses"]
```

## Model 1: Arithmetic mean
```{r include=FALSE}
#mean model for primary energy consumption
MEAN_seas1_I <- meanf(y = ts_forPE_I_train, h =n_for)  
checkresiduals(MEAN_seas1_I)


#mean model for energy losses
MEAN_seas2_I <- meanf(y = ts_forEL_I_train, h = n_for)  
checkresiduals(MEAN_seas2_I)
plot(MEAN_seas2_I)
```

```{r echo=FALSE}
plot(MEAN_seas1_I)
```

```{r echo=FALSE}
plot(MEAN_seas2_I)
```

## Model 2: Seasonal naive
```{r include=FALSE}
#seasonal naive model for primary energy consumption
SNAIVE_seas1_I <- snaive(ts_forPE_I_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas1_I)

#seasonal naive model for energy losses
SNAIVE_seas2_I <- snaive(ts_forEL_I_train, h=n_for, holdout=FALSE)
checkresiduals(SNAIVE_seas2_I)
```

```{r echo=FALSE}
plot(SNAIVE_seas1_I)
```

```{r echo=FALSE}
plot(SNAIVE_seas2_I)
```



## Model 3: SARIMA
```{r include=FALSE}
##SARIMA model for primary energy consumption
SARIMA_autofit1_I <- auto.arima(ts_forPE_I_train)
checkresiduals(SARIMA_autofit1_I)

SARIMA_for1_I <- forecast(SARIMA_autofit1_I,h=n_for)


##SARIMA model for energy losses
SARIMA_autofit2_I <- auto.arima(ts_forEL_I_train)

SARIMA_for2_I <- forecast(SARIMA_autofit2_I,h=n_for)

```

```{r echo=FALSE}
plot(SARIMA_for1_I)
```

```{r echo=FALSE}
plot(SARIMA_for2_I)
```

## Fitting State Space Models to the original (seasonal) series
## Model 4: SS Exponential smoothing

```{r include=FALSE}
##SSEAS model for primary energy consumption
SSES_seas1_I <- es(ts_forPE_I_train,model="ZZZ",h=n_for,holdout=FALSE)
plot(SSES_seas1_I)
checkresiduals(SSES_seas1_I)

##SSEAS model for energy losses
SSES_seas2_I <- es(ts_forEL_I_train,model="XXX",h=n_for,holdout=FALSE)
plot(SSES_seas2_I)
checkresiduals(SSES_seas2_I)
```

```{r echo=FALSE}
autoplot(ts_forPE_I_train) +
  autolayer(SSES_seas1_I$forecast, series="SSES") +
  xlab("Month") + ylab("Primary Energy Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))

```

```{r echo=FALSE}
autoplot(ts_forEL_I_train) +
  autolayer(SSES_seas2_I$forecast, series="SSES") +
  xlab("Month") + ylab("Energy Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```

### Model 5: SS with StructTS()


```{r include=FALSE}
#For primary energy consumption
SS_seas1_I <- StructTS(ts_forPE_I_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas1_I)

#For energy losses
SS_seas2_I <- StructTS(ts_forEL_I_train,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(SS_seas2_I)

#Generating forecasts
SS_for1_I <- forecast(SS_seas1_I,h=n_for)

SS_for2_I <- forecast(SS_seas2_I,h=n_for)

```

```{r echo=FALSE}
plot(SS_for1_I)
```

```{r echo=FALSE}
plot(SS_for2_I)
```

## Checking accuracy of the five models

```{r include=FALSE}
#Model 1: Arithmetic mean
MEAN_scores1_I <- accuracy(MEAN_seas1_I$mean,last_forPE_obs_I_test)
MEAN_scores2_I <- accuracy(MEAN_seas2_I$mean,last_EL_obs_I_test)

#Model 2: Seasonal naive 
SNAIVE_scores1_I <- accuracy(SNAIVE_seas1_I$mean,last_forPE_obs_I_test)
SNAIVE_scores2_I <- accuracy(SNAIVE_seas2$mean,last_EL_obs_I_test)

# Model 3:  SARIMA 
SARIMA_scores1_I <- accuracy(SARIMA_for1_I$mean,last_forPE_obs_I_test)
SARIMA_scores2_I <- accuracy(SARIMA_for2_I$mean,last_EL_obs_I_test)

# Model 4:  SSES
SSES_scores1_I <- accuracy(SSES_seas1_I$forecast,last_forPE_obs_I_test)
SSES_scores2_I <- accuracy(SSES_seas2_I$forecast,last_EL_obs_I_test)

# Model 5:  BSM 
SS_scores1_I <- accuracy(SS_for1_I$mean,last_forPE_obs_I_test)
SS_scores2_I <- accuracy(SS_for2_I$mean,last_EL_obs_I_test)
```

```{r include=FALSE}
#create data frame for primary energy consumption
seas_scores1_I <- as.data.frame(rbind(MEAN_scores1_I, SNAIVE_scores1_I, SARIMA_scores1_I,SSES_scores1_I,SS_scores1_I))
row.names(seas_scores1_I) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index1_I_RMSE <- which.min(seas_scores1_I[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores1_I[best_model_index1_I_RMSE,]))        
  
                            
```

```{r echo=FALSE}

kbl_PE_I<-kbl(seas_scores1_I, 
      caption = "Forecast Accuracy for Industrial Primary Energy Consumption's Seasonal Data",
      digits = array(5,ncol(seas_scores1_I))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores1_I[,"RMSE"]))

kbl_PE_I
```


```{r include=FALSE}
#create data frame for industrial energy losses
seas_scores2_I <- as.data.frame(rbind(MEAN_scores2_I, SNAIVE_scores2_I, SARIMA_scores2_I,SSES_scores2_I,SS_scores2_I))
row.names(seas_scores2_I) <- c("MEAN", "SNAIVE","SARIMA","SSES","BSM")

#choose model with lowest RMSE
best_model_index2_I_RMSE <- which.min(seas_scores2_I[,"RMSE"])
cat("The best model by RMSE is:", row.names(seas_scores2_I[best_model_index2_I_RMSE,]))      
                            
```

```{r echo=FALSE}

kbl_EL_I<-kbl(seas_scores2_I, 
      caption = "Forecast Accuracy for Industrial Enegy Losses' Seasonal Data",
      digits = array(5,ncol(seas_scores2_I))) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  kable_styling(latex_options="striped", stripe_index = which.min(seas_scores2_I[,"RMSE"]))

kbl_EL_I
```

## Plotting everything together

```{r echo=FALSE}
#Industrial Primary Energy
autoplot(ts_electricity_I[,"Primary.Energy"]) +
  autolayer(MEAN_seas1_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_I, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for1_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_I$forecast, series="SSES") +
  autolayer(SS_for1_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

#Industrial Primary Energy - only last year
autoplot(ts_electricity_I_PE_test) +
  autolayer(MEAN_seas1_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas1_I, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for1_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas1_I$forecast, series="SSES") +
  autolayer(SS_for1_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Consumption (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))

```


```{r echo=FALSE} 
#Industrial Energy Losses
autoplot(ts_electricity_I[,"Energy.Losses"]) +
  autolayer(MEAN_seas2_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_I, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for2_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_I$forecast, series="SSES") +
  autolayer(SS_for2_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 1973-2022"))

#Industrial Energy Losses - only last year
autoplot(ts_electricity_I_EL_test) +
  autolayer(MEAN_seas2_I, PI=FALSE, series="Mean") +
  autolayer(SNAIVE_seas2_I, PI=FALSE, series="Naïve") +
  autolayer(SARIMA_for2_I,PI=FALSE, series="SARIMA") +
  autolayer(SSES_seas2_I$forecast, series="SSES") +
  autolayer(SS_for2_I,PI=FALSE,series="BSM") + 
  xlab("Month") + ylab("Electricity Losses (Trillion BTU)") +
  guides(colour=guide_legend(title="Forecast 2017-2022"))
```

### Fit Best Model 
```{r include=FALSE}
#Now fit BSM (the best model) using the entire dataset for PE consumption in industrial sector 

#Create a ts object for the entire PE consumption 
ts_electricity_I_PE <- ts(
  electricity_consumption_I[,2],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#For primary energy consumption
BSM_entire_PE_I <- StructTS(ts_electricity_I_PE,
                    type="BSM",fixed=c(NA,NA,NA,NA))
checkresiduals(BSM_entire_PE_I )

#Generating forecast for the next ten years for the primary energy consumption
BSM_entire_forecast1_I <- forecast(BSM_entire_PE_I,h=120)
plot(BSM_entire_forecast1_I)

```

```{r echo=FALSE}
plot(BSM_entire_forecast1_I)
```



```{r include=FALSE}
#Fit SARIMA using the entire dataset for energy loss in industrial sector 

#Create a ts object for the entire energy loss
ts_electricity_I_EL <- ts(
  electricity_consumption_I[,3],
  start=c(1973,02,01),end=c(2022,11,01),
  frequency=12)

#For energy loss 
SARIMA_entire_EL_I <- auto.arima(ts_electricity_I_EL)
checkresiduals(SARIMA_entire_EL_I )

#Generating forecasts for the next ten years of energy losses
SARIMA_entire_forecast2_I <- forecast(SARIMA_entire_EL_I,h=120)
plot(SARIMA_entire_forecast2_I)
```

```{r echo=FALSE}
plot(SARIMA_entire_forecast2_I)
```



```{r echo=FALSE}
#best models residuals
#Residential sector 1973-2022
checkresiduals(SSES_seas1)
checkresiduals(SSES_seas1)

#Commercial sector
checkresiduals(SARIMA_autofit1_C)
checkresiduals(SS_seas2_C)

#Industrial sector
checkresiduals(SS_seas1_I)
checkresiduals(SARIMA_autofit2_I)
```


